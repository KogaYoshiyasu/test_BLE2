<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>BLE RSSI リアルタイム受信 & ルート案内</title>
</head>
<body>
  <h1>BLE RSSI スキャン & ルート案内</h1>

  <button id="scan">スキャン開始</button>
  <button id="stop" disabled>スキャン停止</button>
  <button id="view" disabled>保存データを見る</button>
  <button id="guide" disabled>案内開始</button>
  <button id="guideStop" disabled>案内停止</button>
  <button id="delete" disabled>データ削除</button>

  <pre id="output"></pre>

  <p id="rssi">RSSI: 未取得</p>
  <p id="avg">平均RSSI: 未取得</p>
  <p id="compare">ルート案内: 未取得</p>

  <div id="savedData" style="margin-top:20px; white-space: pre-wrap;"></div>

<script>
    const maxSamples = 10;

    let rssiArray = [];
    let averageArray = [];

    let scan;
    let advertisementHandler;

    const DEVICE_UUID = '12345678-1234-5678-1234-56789abcdef0';

    const scanButton = document.getElementById('scan');
    const stopButton = document.getElementById('stop');
    const viewButton = document.getElementById('view');
    const guideButton = document.getElementById('guide');
    const guideStopButton = document.getElementById('guideStop');
    const deleteButton = document.getElementById('delete');

    function calculateAverage(array) {
      return array.reduce((sum, val) => sum + val, 0) / array.length;
    }

    function updateRouteGuide(average, routeData, compareElement) {
      if (!routeData?.route?.length) return;

      const route = routeData.route.map(Number);
      let closestIndex = 0;
      let minDiff = Infinity;
      for (let i = 0; i < route.length; i++) {
        const diff = Math.abs(average - route[i]);
        if (diff < minDiff) {
          minDiff = diff;
          closestIndex = i;
        }
      }

      const percent = ((closestIndex + 1) / route.length * 100).toFixed(0);
      const nextHint = (closestIndex < route.length - 1)
        ? (average < route[closestIndex + 1] ? '近づいています' : '遠ざかっています')
        : 'ルートの終点です';

      compareElement.innerText =
        `現在位置はルートの ${percent}% \n` +
        `次のRSSI: ${route[closestIndex + 1] || 'なし'}（${nextHint}）`;
    }

    function createAdvertisementHandler(targetArray, onAverageReady) {
      return (event) => {
        if (event.rssi !== undefined && event.rssi < 0) {
          targetArray.push(event.rssi);
          document.getElementById('rssi').innerText = `RSSI: ${event.rssi}`;

          if (targetArray.length % maxSamples === 0) {
            const recent = targetArray.slice(-maxSamples);
            const avg = calculateAverage(recent);
            document.getElementById('avg').innerText = `平均RSSI: ${avg.toFixed(2)}`;

            if (onAverageReady) {
              onAverageReady(avg);
            }
          }
        }
      };
    }

    async function startBluetoothScan() {
      const options = {
        filters: [{ services: [DEVICE_UUID] }],
        keepRepeatedDevices: true
      };
      return await navigator.bluetooth.requestLEScan(options);
    }

    function saveData() {
      localStorage.setItem('rssiData', JSON.stringify(rssiArray));

      const route = { timestamp: new Date().toISOString(), route: averageArray.map(Number) };

      localStorage.setItem('rssiRoute', JSON.stringify(route));

      alert('データ保存完了');
    }

    scanButton.addEventListener('click', async () => {
      try {
        scan = await startBluetoothScan();
        rssiArray = [];
        averageArray = [];

        advertisementHandler = createAdvertisementHandler(rssiArray, (avg) => {
          averageArray.push(avg.toFixed(2));
        });
        navigator.bluetooth.addEventListener('advertisementreceived', advertisementHandler);

        scanButton.disabled = true;
        stopButton.disabled = false;
        viewButton.disabled = true;
        guideButton.disabled = true;
        guideStopButton.disabled = true;
        deleteButton.disabled = true;

      } catch (err) {
        alert('スキャンエラー: ' + err);
      }
    });

    stopButton.addEventListener('click', () => {
      if (scan?.active) scan.stop();
      if (advertisementHandler) {
        navigator.bluetooth.removeEventListener('advertisementreceived', advertisementHandler);
      }

      saveData();

      scanButton.disabled = false;
      stopButton.disabled = true;
      viewButton.disabled = false;
      guideButton.disabled = false;
      guideStopButton.disabled = true;
      deleteButton.disabled = false;

      if (localStorage.getItem('rssiRoute')) {
        guideButton.disabled = false;
      }
    });

    viewButton.addEventListener('click', () => {
      const rssi = localStorage.getItem('rssiData');
      const routeData = localStorage.getItem('rssiRoute');
      const output = document.getElementById('savedData');

      if (routeData && rssi) { 
        const data = JSON.parse(routeData);
        const rssiData = JSON.parse(rssi);
        output.innerText =
          `\n保存日時: ${data.timestamp}\nRSSI (${rssiData.length}件):\n${rssiData.join(', ')}\n平均RSSI (${data.route.length}件):\n${data.route.join(', ')}\n\n`;
      } else {
        output.innerText = '保存されたRSSIデータはありません。';
      }
    });

    guideButton.addEventListener('click', async () => {
      const routeData = JSON.parse(localStorage.getItem('rssiRoute'));

      if (!routeData?.route?.length) { 
        alert('ルートデータが必要です');
        return;
      }

      try {
        scan = await startBluetoothScan();
        let guideArray = [];

        advertisementHandler = (event) => {
          if (event.rssi < 0) {
            if (event.uuids?.includes(DEVICE_UUID)) {
              guideArray.push(event.rssi);
              if (guideArray.length % maxSamples === 0) {
                const avg = calculateAverage(guideArray.slice(-maxSamples));
                updateRouteGuide(avg, routeData, document.getElementById('compare'));
              }
            }
          }
        };

        navigator.bluetooth.addEventListener('advertisementreceived', advertisementHandler);

      } catch (err) {
        alert('スキャンエラー: ' + err);
      }

      guideButton.disabled = true;
      guideStopButton.disabled = false;
      scanButton.disabled = true;
      stopButton.disabled = true;
      viewButton.disabled = true;
      deleteButton.disabled = true;
    });

    guideStopButton.addEventListener('click', () => {
      if (scan?.active) scan.stop();
      if (advertisementHandler) {
        navigator.bluetooth.removeEventListener('advertisementreceived', advertisementHandler);
      }

      scanButton.disabled = false;
      stopButton.disabled = false;
      viewButton.disabled = false;
      deleteButton.disabled = false;
      guideButton.disabled = false;
      guideStopButton.disabled = true;
    });

    deleteButton.addEventListener('click', () => {
      localStorage.clear();

      scanButton.disabled = false;
      stopButton.disabled = true;
      viewButton.disabled = true;
      deleteButton.disabled = true;
      guideButton.disabled = true;
      guideStopButton.disabled = true;

      alert('ローカルストレージを削除しました');
    });

  </script>
