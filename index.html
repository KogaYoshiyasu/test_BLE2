<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>BLE距離推定</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    .log { margin-top: 1em; }
  </style>
</head>
<body>
  <h1>BLE距離推定ツール</h1>
  <button id="start-scan">スキャン開始</button>

  <div class="log" id="log"></div>

  <script>
    document.getElementById("start-scan").addEventListener("click", async () => {
      try {
        const scan = await navigator.bluetooth.requestLEScan({
          acceptAllAdvertisements: true
        });

        navigator.bluetooth.addEventListener('advertisementreceived', event => {
          const deviceName = event.device.name || '(名前なし)';
          const rssi = event.rssi;
          const txPower = -59; // 通常のTxPower仮定値（必要に応じて調整）

          // 距離推定計算
          const distance = Math.pow(10, (txPower - rssi) / 20);

          // 表示更新
          const logDiv = document.getElementById('log');
          logDiv.innerHTML = `
            <p>📡 デバイス名: <strong>${deviceName}</strong></p>
            <p>🔋 RSSI: ${rssi} dBm</p>
            <p>📏 推定距離: <strong>${distance.toFixed(2)} m</strong></p>
            <hr>
          `;
        });

      } catch (err) {
        alert("スキャンに失敗しました: " + err);
      }
    });
  </script>
</body>
</html>
