<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>BLE RSSI ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å—ä¿¡ & ãƒ«ãƒ¼ãƒˆæ¡ˆå†…</title>
</head>
<body>
  <h1>BLE RSSI ã‚¹ã‚­ãƒ£ãƒ³ & ãƒ«ãƒ¼ãƒˆæ¡ˆå†…</h1>

  <button id="scan">ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
  <button id="stop" disabled>ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢</button>
  <button id="view">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹</button>
  <button id="guide">æ¡ˆå†…é–‹å§‹</button>

  <p id="rssi">RSSI: æœªå–å¾—</p>
  <p id="avg">å¹³å‡RSSI: æœªå–å¾—</p>
  <p id="compare">ãƒ«ãƒ¼ãƒˆæ¡ˆå†…: æœªå–å¾—</p>

  <div id="savedData" style="margin-top:20px; white-space: pre-wrap;"></div>

  <script>
    const rssiArray = [];
    const temp = [];
    const averageArray = [];
    const maxSamples = 10;
    let scan;
    let advertisementHandler;
  
    const scanButton = document.getElementById('scan');
    const stopButton = document.getElementById('stop');
    const viewButton = document.getElementById('view');
    const guideButton = document.getElementById('guide');
  
    function calculateAverage(arr) {
      const avg = arr.reduce((sum, val) => sum + val, 0) / arr.length;
      return avg;
    }
  
    function updateRouteGuidance(average) {
      const routeData = JSON.parse(localStorage.getItem('rssiRoute'));
      if (!routeData || !routeData.route || routeData.route.length === 0) return;
  
      const route = routeData.route.map(Number);
      let closestIndex = 0;
      let minDiff = Infinity;
      for (let i = 0; i < route.length; i++) {
        const diff = Math.abs(average - route[i]);
        if (diff < minDiff) {
          minDiff = diff;
          closestIndex = i;
        }
      }
  
      const percent = ((closestIndex + 1) / route.length * 100).toFixed(0);
      const nextHint = (closestIndex < route.length - 1)
        ? (average < route[closestIndex + 1] ? 'è¿‘ã¥ãæ–¹å‘' : 'é ã–ã‹ã‚‹æ–¹å‘')
        : 'ãƒ«ãƒ¼ãƒˆã®çµ‚ç‚¹ã§ã™';
  
      document.getElementById('compare').innerText =
        `ğŸ“ ç¾åœ¨ä½ç½®ã¯ãƒ«ãƒ¼ãƒˆã® ${percent}% ã‚ãŸã‚Š\n` +
        `ğŸ‘‰ æ¬¡ã®RSSIç›®æ¨™: ${route[closestIndex + 1] || 'ãªã—'}ï¼ˆ${nextHint}ï¼‰`;
    }
  
    function saveData() {
      const saveData = {
        timestamp: new Date().toISOString(),
        averageRSSISequence: averageArray,
      };
  
      localStorage.setItem('rssiData', JSON.stringify(temp));
      localStorage.setItem('rssiDataAve', JSON.stringify(saveData));
  
      if (averageArray.length > 0) {
        const route = {
          timestamp: new Date().toISOString(),
          route: averageArray.map(Number)
        };
        localStorage.setItem('rssiRoute', JSON.stringify(route));
        alert('ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢ãƒ»ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»ãƒ«ãƒ¼ãƒˆä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸ');
      } else {
        alert('ã‚¹ã‚­ãƒ£ãƒ³åœæ­¢ãƒ»ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ«ãƒ¼ãƒˆã¯ç©ºã§ã™ï¼‰');
      }
    }
  
    scanButton.addEventListener('click', async () => {
      try {
        const options = {
          filters: [{ services: ['12345678-1234-5678-1234-56789abcdef0'] }],
          // acceptAllAdvertisements: true,
          keepRepeatedDevices: true
        };
  
        scan = await navigator.bluetooth.requestLEScan(options);
  
        advertisementHandler = (event) => {
          if (event.rssi !== undefined && event.rssi < 0) {
            temp.push(event.rssi);
            rssiArray.push(event.rssi);
            document.getElementById('rssi').innerText = `RSSI: ${event.rssi}`;
  
            if (rssiArray.length % maxSamples === 0) {
              const recent = rssiArray.slice(-maxSamples);
              const avg = calculateAverage(recent);
              averageArray.push(avg.toFixed(2));
              document.getElementById('avg').innerText = `å¹³å‡RSSI: ${avg.toFixed(2)}`;
  
              updateRouteGuidance(avg);
            }
          }
        };
  
        navigator.bluetooth.addEventListener('advertisementreceived', advertisementHandler);
        scanButton.disabled = true;
        stopButton.disabled = false;
  
      } catch (err) {
        alert('ã‚¹ã‚­ãƒ£ãƒ³ã‚¨ãƒ©ãƒ¼: ' + err);
      }
    });
  
    stopButton.addEventListener('click', () => {
      if (scan?.active) scan.stop();
      if (advertisementHandler) {
        navigator.bluetooth.removeEventListener('advertisementreceived', advertisementHandler);
      }
  
      saveData();
      scanButton.disabled = false;
      stopButton.disabled = true;
    });
  
    viewButton.addEventListener('click', () => {
      const rssi = localStorage.getItem('rssiData');
      const saved = localStorage.getItem('rssiDataAve');
      const output = document.getElementById('savedData');
  
      if (saved && rssi) {
        const data = JSON.parse(saved);
        const rssiData = JSON.parse(rssi);
        output.innerText =
          `ä¿å­˜æ—¥æ™‚: ${data.timestamp}\n` +
          `RSSI (${rssiData.length}ä»¶):\n${rssiData.join(', ')}\n\n` +
          `å¹³å‡RSSIã‚·ãƒ¼ã‚±ãƒ³ã‚¹ (${data.averageRSSISequence.length}ä»¶):\n${data.averageRSSISequence.join(', ')}`;
      } else {
        output.innerText = 'ä¿å­˜ã•ã‚ŒãŸRSSIãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
      }
    });
  
    guideButton.addEventListener('click', () => {
      const routeData = JSON.parse(localStorage.getItem('rssiRoute'));
      if (!routeData?.route?.length) {
        alert('æ¡ˆå†…ã«ä½¿ãˆã‚‹ãƒ«ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
  
      const recent = rssiArray.slice(-maxSamples);
      if (recent.length < maxSamples) {
        alert('æ¡ˆå†…ã«ã¯å°‘ãªãã¨ã‚‚10ä»¶ã®RSSIãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™');
        return;
      }
  
      const avg = calculateAverage(recent);
      updateRouteGuidance(avg);
      alert('æ¡ˆå†…ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
    });
  </script>  
</body>
</html>
