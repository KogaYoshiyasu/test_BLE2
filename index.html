<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>データ送信・取得テスト</title>
</head>
<body>
  <h1>データ送受信テスト</h1>
  <button id="send">データ送信</button>
  <button id="load">データ取得</button>
  <button id="delete">データ削除</button>
  <pre id="output"></pre>

  <script>
    document.getElementById("send").onclick = () => {
      fetch("https://excepable-jazmine-counteractingly.ngrok-free.dev/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ time: new Date().toISOString(), value: Math.random() }),
      })
      .then(r => r.json())
      .then(d => console.log("サーバー応答:", d))
      .catch(e => console.error("送信エラー:", e));
    };

    /*document.getElementById("load").onclick = () => {
      console.log("loadボタンが押されました");
      fetch("https://excepable-jazmine-counteractingly.ngrok-free.dev/data")
      .then(response => {
        console.log("レスポンス");
        if (!response.ok) {
          console.log("エラー");
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        console.log("レスポンス2");
        return response.json();
        console.log("レスポンス3");
      })
      .then(data => {
        console.log("取得データ:", data);
        document.getElementById("output").textContent = JSON.stringify(data, null, 2);
      })
      .catch(err => console.error("取得エラー:", err));
    }*/

document.getElementById("load").onclick = () => {
  console.log("loadボタン押された");

  // URLは固定と仮定（毎回同じドメイン）
  const url = "https://excepable-jazmine-counteractingly.ngrok-free.dev/data"; 
  
  fetch(url)
    .then(response => {
      console.log("レスポンスステータス:", response.status);
      console.log("Content-Type:", response.headers.get("content-type"));
      
      // ステータスコードが200番台以外、またはContent-TypeがJSONでない場合はエラーを投げる
      if (!response.ok || !response.headers.get("content-type")?.includes("application/json")) {
        // エラーレスポンスをテキストとして取得し、エラーメッセージに含める
        return response.text().then(text => {
            throw new Error(`サーバーエラー (Status: ${response.status})。Content-TypeがJSONではありませんでした。`);
        });
      }
      
      // 正常なJSONレスポンスをパース
      return response.json();
    })
    .then(data => {
      console.log("JSONパース成功、取得データ:", data);
      document.getElementById("output").textContent = JSON.stringify(data, null, 2);
    })
    .catch(err => {
      console.error("取得エラー:", err);
      // SyntaxErrorやカスタムエラーを捕捉
      document.getElementById("output").textContent = `データの取得に失敗しました: ${err.message}`;
    });
};

    /*document.getElementById("load").onclick = () => {
      fetch("https://excepable-jazmine-counteractingly.ngrok-free.dev/data")
        .then(r => r.json())
        .then(data => {
          console.log("取得データ:", data);
          document.getElementById("output").textContent = JSON.stringify(data, null, 2);
        })
        .catch(e => console.error("取得エラー:", e));
    };*/
    
    document.getElementById("delete").onclick = () => {
      fetch("https://excepable-jazmine-counteractingly.ngrok-free.dev/data", { method: "DELETE" })
        .then(r => r.json())
        .then(d => console.log("削除結果:", d))
        .catch(e => console.error("削除エラー:", e));
    };
  </script>
</body>
</html>
