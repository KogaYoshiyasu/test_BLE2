<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>データ送信・取得テスト</title>
</head>
<body>
  <h1>データ送受信テスト</h1>
  <button id="send">データ送信</button>
  <button id="load">データ取得</button>
  <button id="delete">データ削除</button>
  <pre id="output"></pre>

  <script>
    document.getElementById("send").onclick = () => {
      fetch("https://excepable-jazmine-counteractingly.ngrok-free.dev/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ time: new Date().toISOString(), value: Math.random() }),
      })
      .then(r => r.json())
      .then(d => console.log("サーバー応答:", d))
      .catch(e => console.error("送信エラー:", e));
    };

    /*document.getElementById("load").onclick = () => {
      console.log("loadボタンが押されました");
      fetch("https://excepable-jazmine-counteractingly.ngrok-free.dev/data")
      .then(response => {
        console.log("レスポンス");
        if (!response.ok) {
          console.log("エラー");
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        console.log("レスポンス2");
        return response.json();
        console.log("レスポンス3");
      })
      .then(data => {
        console.log("取得データ:", data);
        document.getElementById("output").textContent = JSON.stringify(data, null, 2);
      })
      .catch(err => console.error("取得エラー:", err));
    }*/

document.getElementById("load").onclick = () => {
  console.log("loadボタン押された");

  // キャッシュを無効化するため、現在のタイムスタンプをクエリパラメータとしてURLに追加
  // これにより、毎回異なるURLとして認識され、キャッシュが無視されます。
  const cacheBusterUrl = "https://excepable-jazmine-counteractingly.ngrok-free.dev/data?t=" + new Date().getTime(); 
  
  // 修正後のURL (cacheBusterUrl) でfetchを実行
  fetch(cacheBusterUrl)
    .then(res => {
      console.log("レスポンスステータス:", res.status);
      // Content-Typeがtext/htmlであれば、ここで判別できます。
      console.log("Content-Type:", res.headers.get("content-type"));
      return res.text();
    })
    .then(text => {
      console.log("レスポンステキスト:", text);
      try {
        const data = JSON.parse(text);
        console.log("JSONパース成功:", data);
        document.getElementById("output").textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        // SyntaxError: Unexpected token '<' など、HTMLが返された場合にここに到達します。
        console.error("JSONパース失敗: サーバーはJSONではないデータを返しました。", e);
        document.getElementById("output").textContent = 
            `エラー: サーバーがHTML（または無効なデータ）を返しました。\n` +
            `レスポンス開始部分: ${text.substring(0, 100)}...`;
      }
    })
    .catch(err => console.error("fetchエラー:", err));
};

    /*document.getElementById("load").onclick = () => {
      fetch("https://excepable-jazmine-counteractingly.ngrok-free.dev/data")
        .then(r => r.json())
        .then(data => {
          console.log("取得データ:", data);
          document.getElementById("output").textContent = JSON.stringify(data, null, 2);
        })
        .catch(e => console.error("取得エラー:", e));
    };*/
    
    document.getElementById("delete").onclick = () => {
      fetch("https://excepable-jazmine-counteractingly.ngrok-free.dev/data", { method: "DELETE" })
        .then(r => r.json())
        .then(d => console.log("削除結果:", d))
        .catch(e => console.error("削除エラー:", e));
    };
  </script>
</body>
</html>
