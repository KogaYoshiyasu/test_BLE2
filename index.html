<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>データ送信・取得テスト</title>
</head>
<body>
  <h1>データ送受信テスト</h1>
  <button id="send">データ送信</button>
  <button id="load">データ取得</button>
  <button id="delete">データ削除</button>
  <pre id="output"></pre>

  <script>
    document.getElementById("send").onclick = () => {
      fetch("https://excepable-jazmine-counteractingly.ngrok-free.dev/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ time: new Date().toISOString(), value: Math.random() }),
      })
      .then(r => r.json())
      .then(d => console.log("サーバー応答:", d))
      .catch(e => console.error("送信エラー:", e));
    };

    /*document.getElementById("load").onclick = () => {
      console.log("loadボタンが押されました");
      fetch("https://excepable-jazmine-counteractingly.ngrok-free.dev/data")
      .then(response => {
        console.log("レスポンス");
        if (!response.ok) {
          console.log("エラー");
          throw new Error(`HTTP error! status: ${response.status}`)
        }
        console.log("レスポンス2");
        return response.json();
        console.log("レスポンス3");
      })
      .then(data => {
        console.log("取得データ:", data);
        document.getElementById("output").textContent = JSON.stringify(data, null, 2);
      })
      .catch(err => console.error("取得エラー:", err));
    }*/

document.getElementById("load").onclick = () => {
  console.log("loadボタン押された");

  // 【重要】ご自身の ngrok URL に置き換えてください
  const NGROK_URL = "https://excepable-jazmine-counteractingly.ngrok-free.dev"; 
  const url = NGROK_URL + "/read";
  
  fetch(url)
    .then(response => {
      console.log("レスポンスステータス:", response.status);
      console.log("Content-Type:", response.headers.get("content-type"));
      
      // 成功ステータスでなくても、レスポンスボディ全体をテキストとして取得
      return response.text();
    })
    .then(text => {
      console.log("レスポンステキスト:", text);

      // JSONパースを試みる
      try {
        const data = JSON.parse(text);
        console.log("JSONパース成功、取得データ:", data);
        document.getElementById("output").textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        // パースが失敗した場合（HTMLが返された場合など）
        
        // エラー内容を画面に出力
        let errorMessage = "データの取得に失敗しました: 無効なデータ形式";
        if (text.trim().startsWith("<!DOCTYPE html>")) {
             // <!DOCTYPE html> で始まる場合は、ngrokまたはEdgeのキャッシュエラーで確定
             errorMessage = "取得エラー: ブラウザが過去のエラーHTMLを返しました。\n\n" + 
                            "これはブラウザのセキュリティキャッシュが原因です。\n" +
                            "再起動/ブラウザデータ削除を試みてください。";
        } else if (text.trim() === "") {
             // 空文字列の場合
             errorMessage = "取得エラー: サーバーから空のレスポンスが返されました。";
        }
        
        document.getElementById("output").textContent = errorMessage;
        console.error("JSONパース失敗:", e);
      }
    })
    .catch(err => {
      console.error("fetchエラー:", err);
      document.getElementById("output").textContent = `通信エラー: ${err.message}`;
    });
};

    /*document.getElementById("load").onclick = () => {
      fetch("https://excepable-jazmine-counteractingly.ngrok-free.dev/data")
        .then(r => r.json())
        .then(data => {
          console.log("取得データ:", data);
          document.getElementById("output").textContent = JSON.stringify(data, null, 2);
        })
        .catch(e => console.error("取得エラー:", e));
    };*/
    
    document.getElementById("delete").onclick = () => {
      fetch("https://excepable-jazmine-counteractingly.ngrok-free.dev/data", { method: "DELETE" })
        .then(r => r.json())
        .then(d => console.log("削除結果:", d))
        .catch(e => console.error("削除エラー:", e));
    };
  </script>
</body>
</html>
