<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>BLE RSSI リアルタイム受信 & ルート案内</title>
</head>
<body>
  <h1>BLE RSSI スキャン & ルート案内</h1>

  <button id="scan">スキャン開始</button>
  <button id="stop" disabled>スキャン停止</button>
  <button id="view" disabled>保存データを見る</button>
  <button id="guide" disabled>案内開始</button>
  <button id="guideStop" disabled>案内停止</button>
  <button id="delete" disabled>データ削除</button>


  <p id="rssi">RSSI: 未取得</p>
  <p id="avg">平均RSSI: 未取得</p>
  <p id="compare">ルート案内: 未取得</p>

  <div id="savedData" style="margin-top:20px; white-space: pre-wrap;"></div>

  <script>
    const maxSamples = 10;
    let rssiArray = [];
    let averageArray = [];
    let scan;
    let advertisementHandler;
  
    const scanButton = document.getElementById('scan');
    const stopButton = document.getElementById('stop');
    const viewButton = document.getElementById('view');
    const guideButton = document.getElementById('guide');
    const guideStopButton = document.getElementById('guideStop');
    const deleteButton = document.getElementById('delete');

    function calculateAverage(array) {
      const average = array.reduce((sum, val) => sum + val, 0) / array.length;
      return average;
    }
  
    function updateRouteGuide(average, routeData) {
      if (!routeData?.route?.length) return;
  
      const route = routeData.route.map(Number);

      let closestIndex = 0;
      let minDiff = Infinity;
      for (let i = 0; i < route.length; i++) {
        const diff = Math.abs(average - route[i]);
        if (diff < minDiff) {
          minDiff = diff;
          closestIndex = i;
        }
      }
  
      const percent = ((closestIndex + 1) / route.length * 100).toFixed(0);
      const nextHint = (closestIndex < route.length - 1)
        ? (average < route[closestIndex + 1] ? '近づいています' : '遠ざかっています')
        : 'ルートの終点です';
  
      document.getElementById('compare').innerText =
        `現在位置はルートの ${percent}% \n` +
        `次のRSSI: ${route[closestIndex + 1] || 'なし'}（${nextHint}）`;
    }

    function createAdvertisementHandler(targetArray, onAverageReady) {
      return (event) => {
        if (event.rssi !== undefined && event.rssi < 0) {
          targetArray.push(event.rssi);
          document.getElementById('rssi').innerText = `RSSI: ${event.rssi}`;

          if (targetArray.length % maxSamples === 0) {
            const recent = targetArray.slice(-maxSamples);
            const avg = calculateAverage(recent);
            document.getElementById('avg').innerText = `平均RSSI: ${avg.toFixed(2)}`;

            if (onAverageReady) {
              onAverageReady(avg);
            }
          }
        }
      };
    }

    async function startBluetoothScan() {
      const options = {
        filters: [{ services: ['12345678-1234-5678-1234-56789abcdef0'] }],
        // acceptAllAdvertisements: true,
        keepRepeatedDevices: true
      };
      return await navigator.bluetooth.requestLEScan(options);
    }

  //サーバにデータを送信に変更
    function saveData(rssiArray) {
  
      //localStorage.setItem('rssiData', JSON.stringify(rssiArray));
  
      if (averageArray.length > 0) {
        /*const route = {
          timestamp: new Date().toISOString(),
          route: averageArray.map(Number)
        };
        localStorage.setItem('rssiRoute', JSON.stringify(route));*/

        fetch("https://localhost:3001/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({  /*time: new Date().toISOString(),*/ value: averageArray.map(Number) }),
        })
        .then(r => r.json())
        .then(d => console.log("サーバー応答:", d))
        .catch(e => console.error("送信エラー:", e));

        alert('スキャン停止・データ保存・ルート保存が完了しました');
      } else {
        alert('スキャン停止・データ保存しました（ルートは空です）');
      }
    }
  
    scanButton.addEventListener('click', async () => {
      try {
        scan = await startBluetoothScan();
  
        rssiArray = []

        advertisementHandler = createAdvertisementHandler(rssiArray, (avg) => {
          averageArray.push(avg.toFixed(2));
        });
  
        navigator.bluetooth.addEventListener('advertisementreceived', advertisementHandler);

        scanButton.disabled = true;
        stopButton.disabled = false;
        viewButton.disabled = true;
        guideButton.disabled = true;
        guideStopButton.disabled = true;
        deleteButton.disabled = true;
  
      } catch (err) {
        alert('スキャンエラー: ' + err);
      }
    });
  
    stopButton.addEventListener('click', () => {
      if (scan?.active) scan.stop();
      if (advertisementHandler) {
        navigator.bluetooth.removeEventListener('advertisementreceived', advertisementHandler);
      }
  
      saveData(rssiArray);

      scanButton.disabled = false;
      stopButton.disabled = true;
      viewButton.disabled = false;
      guideButton.disabled = false;
      guideStopButton.disabled = true;
      deleteButton.disabled = false;

    });
  
    /*viewButton.addEventListener('click', () => {
      const rssi = localStorage.getItem('rssiData');
      const routeData = localStorage.getItem('rssiRoute');
      const output = document.getElementById('savedData');
  
      if (routeData && rssi) {
        const data = JSON.parse(routeData);
        const rssiData = JSON.parse(rssi);
        output.innerText =
          `保存日時: ${data.timestamp}\n` +
          `RSSI (${rssiData.length}件):\n${rssiData.join(', ')}\n\n` +
          `平均RSSI (${data.route.length}件):\n${data.route.join(', ')}`;
      } else {
        output.innerText = '保存されたRSSIデータはありません。';
      }
    });*/
  
    //サーバからデータを取得に変更
    guideButton.addEventListener('click', async () => {
      //const routeData = JSON.parse(localStorage.getItem('rssiRoute'));
      
      try{
        const res = await fetch("https://localhost:3001/data");
        const data = await res.json();
        console.log("取得データ:", data);

        // 最後のデータを案内ルートとして使う
        const routeData = Array.isArray(data) ? { route: data[data.length - 1].value } : data;

        if (!routeData?.route?.length) {
          alert('案内に使えるルートデータがありません');
          return;
        }

        const recent = rssiArray.slice(-maxSamples);
        if (recent.length < maxSamples) {
          alert('案内には少なくとも10件のRSSIデータが必要です');
          return;
        }
        
        //RSSIスキャンを再開して現在位置を案内
        scan = await startBluetoothScan();
      
        let guideArray = [];

        advertisementHandler = createAdvertisementHandler(guideArray, (avg) => {
          updateRouteGuide(avg, routeData);
        });
  
        navigator.bluetooth.addEventListener('advertisementreceived', advertisementHandler);

      scanButton.disabled = true;
      stopButton.disabled = true;
      viewButton.disabled = true;
      deleteButton.disabled = true;
      guideButton.disabled = true;
      guideStopButton.disabled = false;

      } catch (err) {
        alert('案内開始エラー: ' + err);
      }

    });

    guideStopButton.addEventListener('click', () => {
      if (scan?.active) scan.stop();
      if (advertisementHandler) {
        navigator.bluetooth.removeEventListener('advertisementreceived', advertisementHandler);
      }

      scanButton.disabled = false;
      stopButton.disabled = false;
      viewButton.disabled = false;
      deleteButton.disabled = false;
      guideButton.disabled = false;
      guideStopButton.disabled = true;

    });

    //サーバのデータを削除に変更
    deleteButton.addEventListener('click', () => {
      //localStorage.clear();

      fetch("https://localhost:3001/data", { method: "DELETE" })
        .then(r => r.json())
        .then(d => console.log("削除結果:", d))
        .catch(e => console.error("削除エラー:", e));

      scanButton.disabled = false;
      stopButton.disabled = true;
      viewButton.disabled = true;
      deleteButton.disabled = true;
      guideButton.disabled = true;
      guideStopButton.disabled = true;

      alert('サーバーデータを削除しました');
    });

  </script>  
</body>
</html>
